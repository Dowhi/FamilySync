<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Configuración de Turnos</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <!-- Tailwind CSS para los estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React y ReactDOM para la funcionalidad -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para transpilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      /* Estilos personalizados para la scrollbar y para asegurar que la app ocupe toda la pantalla */
      html, body, #root {
        height: 100%;
        overflow: hidden;
      }
      body {
        background-color: #37474f; /* Un fondo oscuro para el 'exterior' de la app en pantallas grandes */
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;

      // Configuración de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyB5vvp7IQOZLO7LlsUY_Wq-H8M_5PH3ZQE",
        authDomain: "apptaxi-f2190.firebaseapp.com",
        projectId: "apptaxi-f2190",
        storageBucket: "apptaxi-f2190.firebasestorage.app",
        messagingSenderId: "804273724178",
        appId: "1:804273724178:web:c5955a1f657884c0e7f1cb",
        measurementId: "G-3D8R30TYTM"
      };

      // Inicializar Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // --- Componentes de Iconos (SVG) ---
      const ChevronDownIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      );

      const ColorWheelIcon = () => (
        <div style={{
            width: '38px',
            height: '38px',
            borderRadius: '50%',
            border: '1px solid #e0e0e0',
            background: 'conic-gradient(from 180deg, red, yellow, lime, cyan, blue, magenta, red)',
            position: 'relative',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
        }}>
            <div style={{
                width: '16px',
                height: '16px',
                backgroundColor: 'white',
                borderRadius: '50%'
            }} />
        </div>
      );

      const CheckIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor">
          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
        </svg>
      );

      const TrashIcon = () => (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      );

      // --- Componentes de UI Reutilizables ---
      const ColorPicker = ({ label, colors, selectedColor, onColorSelect }) => {
        const scrollContainerRef = useRef(null);
        const [canScrollPrev, setCanScrollPrev] = useState(false);
        const [canScrollNext, setCanScrollNext] = useState(true);

        const ITEM_WIDTH = 44 + 12; // Ancho del item (w-11 -> 44px) + espacio (space-x-3 -> 12px)

        const handleScroll = () => {
            if (!scrollContainerRef.current) return;
            const { scrollLeft, scrollWidth, clientWidth } = scrollContainerRef.current;
            setCanScrollPrev(scrollLeft > 0);
            // Se resta 1 para evitar problemas de precisión con decimales
            setCanScrollNext(scrollLeft < scrollWidth - clientWidth - 1);
        };

        useEffect(() => {
            const container = scrollContainerRef.current;
            if (container) {
                handleScroll(); // Comprobar estado inicial
                container.addEventListener('scroll', handleScroll, { passive: true });
                window.addEventListener('resize', handleScroll);
                return () => {
                    container.removeEventListener('scroll', handleScroll);
                    window.removeEventListener('resize', handleScroll);
                };
            }
        }, [colors]);

        const scroll = (direction) => {
            if (!scrollContainerRef.current) return;
            const scrollAmount = direction * ITEM_WIDTH;
            scrollContainerRef.current.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        };
        
        return (
          <div className="bg-white rounded-xl shadow p-3 mb-4">
            <h3 className="text-xs font-bold text-gray-500 uppercase mb-3 px-1">{label}</h3>
            <div className="flex items-center">
              <button className="p-1"><ColorWheelIcon /></button>
              
              <button 
                onClick={() => scroll(-1)} 
                disabled={!canScrollPrev}
                className="p-1 text-gray-400 hover:text-gray-600 disabled:text-gray-200 disabled:cursor-not-allowed transition-colors"
                aria-label="Color anterior"
              >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
              </button>

              <div 
                ref={scrollContainerRef}
                className="flex-1 flex items-center overflow-x-auto no-scrollbar space-x-3 px-2"
              >
                {colors.map((color) => (
                  <button
                    key={color}
                    onClick={() => onColorSelect(color)}
                    className="relative w-11 h-11 rounded-lg flex-shrink-0 flex items-center justify-center transition-transform duration-150 transform hover:scale-110 shadow-inner"
                    style={{ 
                      backgroundColor: color,
                      border: (color === '#FFFFFF' || color === '#000000') ? '1px solid #ddd' : 'none'
                    }}
                    aria-label={`Seleccionar color ${color}`}
                  >
                    {selectedColor === color && (
                       <div className="absolute bottom-1 right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-white flex items-center justify-center shadow">
                          <CheckIcon />
                      </div>
                    )}
                  </button>
                ))}
              </div>

              <button 
                onClick={() => scroll(1)} 
                disabled={!canScrollNext}
                className="p-1 text-gray-400 hover:text-gray-600 disabled:text-gray-200 disabled:cursor-not-allowed transition-colors"
                aria-label="Siguiente color"
              >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
              </button>
            </div>
          </div>
        );
      };

      // Componente de Slot de Tiempo
      const TimeSlot = ({ slot, index, onUpdate, onDelete }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [startTime, setStartTime] = useState(slot.startTime || '08:00');
        const [endTime, setEndTime] = useState(slot.endTime || '17:00');
        const [isActive, setIsActive] = useState(slot.active !== false);

        const handleSave = () => {
          onUpdate(index, { startTime, endTime, active: isActive });
          setIsEditing(false);
        };

        const handleToggle = () => {
          setIsActive(!isActive);
          onUpdate(index, { startTime, endTime, active: !isActive });
        };

        return (
          <div className="bg-white rounded-lg shadow-sm p-2 mb-2">
            <div className="flex items-center gap-2">
              <div className="flex items-center flex-1 min-w-0">
                <div className="flex items-center gap-1 flex-1">
                  {isEditing ? (
                    <>
                      <input
                        type="time"
                        value={startTime}
                        onChange={(e) => setStartTime(e.target.value)}
                        className="flex-1 p-1 border border-gray-300 rounded text-xs max-w-[80px]"
                      />
                      <span className="text-gray-500 text-xs">-</span>
                      <input
                        type="time"
                        value={endTime}
                        onChange={(e) => setEndTime(e.target.value)}
                        className="flex-1 p-1 border border-gray-300 rounded text-xs max-w-[80px]"
                      />
                    </>
                  ) : (
                    <>
                      <div className="px-2 py-1 bg-gray-100 rounded text-xs font-semibold">
                        {startTime}
                      </div>
                      <span className="text-gray-500 text-xs">-</span>
                      <div className="px-2 py-1 bg-gray-100 rounded text-xs font-semibold">
                        {endTime}
                      </div>
                    </>
                  )}
                </div>

                <button
                  onClick={handleToggle}
                  className={`px-3 py-1 rounded-full text-xs font-semibold transition-colors whitespace-nowrap ${
                    isActive 
                      ? 'bg-green-500 text-white' 
                      : 'bg-gray-200 text-gray-600'
                  }`}
                >
                  {isActive ? 'Activo' : 'Inactivo'}
                </button>
              </div>

              <div className="flex items-center gap-1">
                {isEditing ? (
                  <button
                    onClick={handleSave}
                    className="px-2 py-1 bg-blue-500 text-white rounded text-xs font-semibold"
                  >
                    ✓
                  </button>
                ) : (
                  <button
                    onClick={() => setIsEditing(true)}
                    className="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs font-semibold"
                  >
                    ✎
                  </button>
                )}
                <button
                  onClick={() => onDelete(index)}
                  className="px-2 py-1 bg-red-500 text-white rounded text-xs font-semibold"
                >
                  ✗
                </button>
              </div>
            </div>
          </div>
        );
      };

      // --- Componente Principal de la Aplicación ---
      function App() {
        const [shiftName, setShiftName] = useState('Nuevo');
        const [abbreviation, setAbbreviation] = useState('F.A.');
        const [bgColor, setBgColor] = useState('#AA1F26');
        const [textColor, setTextColor] = useState('#D9F5D9');
        const [textSize, setTextSize] = useState(12);
        const [activeTab, setActiveTab] = useState('ASPECTO');
        const [timeSlots, setTimeSlots] = useState([
          { startTime: '08:00', endTime: '17:00', active: true },
          { startTime: '20:00', endTime: '08:00', active: true }
        ]);
        const [shiftId, setShiftId] = useState(null);

        const bgColors = [
          '#FFB3BA', '#FF9AA2', '#AA1F26', '#8B4513', '#5D4037',
          '#FFD93D', '#FF9800', '#FFEB3B', '#4CAF50', '#2196F3',
          '#9C27B0', '#E91E63', '#00BCD4', '#795548',
          '#000000', '#FFFFFF', '#808080', '#C0C0C0'
        ];
        const textColors = [
          '#D3D3D3', '#FFFFFF', '#D9F5D9', '#FFE5B4', '#FFFFCC',
          '#C8E6C9', '#B3E5FC', '#E1BEE7', '#FFCDD2', '#F8BBD0',
          '#FFF9C4', '#DCEDC8', '#BBDEFB', '#D1C4E9',
          '#000000', '#757575', '#9E9E9E', '#BDBDBD'
        ];

        const tabs = ['ASPECTO', 'HORARIOS', 'ACCIONES'];

        // Cargar datos del turno si se está editando
        useEffect(() => {
          const urlParams = new URLSearchParams(window.location.search);
          const id = urlParams.get('id');
          
          if (id) {
            setShiftId(id);
            loadShiftData(id);
          }
        }, []);

        const loadShiftData = async (id) => {
          try {
            const doc = await db.collection('shifts').doc(id).get();
            if (doc.exists) {
              const data = doc.data();
              console.log('📥 Datos cargados:', data);
              
              setShiftName(data.name || 'Nuevo');
              setAbbreviation(data.abbreviation || 'F.A.');
              setBgColor(data.backgroundColor || data.colorHex || '#AA1F26');
              setTextColor(data.textColor || '#D9F5D9');
              setTextSize(data.textSize || 12);
              
              if (data.timeSlots && data.timeSlots.length > 0) {
                setTimeSlots(data.timeSlots);
              } else if (data.startTime && data.endTime) {
                // Compatibilidad con formato antiguo
                setTimeSlots([{ startTime: data.startTime, endTime: data.endTime, active: true }]);
              }
            } else {
              console.warn('⚠️ Turno no encontrado');
            }
          } catch (error) {
            console.error('❌ Error cargando turno:', error);
          }
        };

        const handleSave = async () => {
          try {
            const shiftData = {
              name: shiftName,
              abbreviation: abbreviation,
              backgroundColor: bgColor,
              textColor: textColor,
              textSize: textSize,
              timeSlots: timeSlots,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (shiftId) {
              // Actualizar turno existente
              await db.collection('shifts').doc(shiftId).update(shiftData);
              console.log('✅ Turno actualizado en Firebase');
            } else {
              // Crear nuevo turno
              shiftData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
              await db.collection('shifts').add(shiftData);
              console.log('✅ Turno guardado en Firebase');
            }
            
            window.location.href = 'shifts.html';
          } catch (error) {
            console.error('❌ Error guardando turno:', error);
            alert('Error al guardar el turno: ' + error.message);
          }
        };

        const handleCancel = () => {
          window.location.href = 'shifts.html';
        };

        const handleDelete = async () => {
          if (!shiftId) {
            alert('Este turno aún no ha sido guardado');
            return;
          }
          
          if (confirm('¿Estás seguro de que quieres eliminar este turno?')) {
            try {
              await db.collection('shifts').doc(shiftId).delete();
              console.log('✅ Turno eliminado de Firebase');
              window.location.href = 'shifts.html';
            } catch (error) {
              console.error('❌ Error eliminando turno:', error);
              alert('Error al eliminar el turno: ' + error.message);
            }
          }
        };

        const handleAddTimeSlot = () => {
          setTimeSlots([...timeSlots, { startTime: '08:00', endTime: '17:00', active: true }]);
        };

        const handleUpdateTimeSlot = (index, updatedSlot) => {
          const newSlots = [...timeSlots];
          newSlots[index] = updatedSlot;
          setTimeSlots(newSlots);
        };

        const handleDeleteTimeSlot = (index) => {
          setTimeSlots(timeSlots.filter((_, i) => i !== index));
        };

        return (
          <div className="flex flex-col h-full w-full bg-[#455a64] text-white font-sans shadow-2xl">
            {/* Header */}
            <header className="p-4 flex flex-col space-y-4 rounded-t-lg">
              <div className="flex justify-center">
                <ChevronDownIcon />
              </div>
              <h1 className="text-xl font-bold text-center tracking-wide">CONFIGURACIÓN DE TURNOS</h1>
              <div className="relative">
                <label htmlFor="shiftName" className="text-sm font-semibold text-gray-300">Nombre del turno</label>
                <div className="flex items-stretch space-x-2 mt-1">
                  <input
                    id="shiftName"
                    type="text"
                    value={shiftName}
                    onChange={(e) => setShiftName(e.target.value)}
                    className="flex-grow bg-white text-black p-3 text-lg rounded-md border-2 border-transparent focus:border-teal-400 focus:ring-0"
                  />
                  <div
                    className="w-16 h-auto flex-shrink-0 rounded-md flex items-center justify-center font-bold relative text-center p-3"
                    style={{
                      backgroundColor: bgColor,
                      color: textColor,
                      fontSize: `${textSize}px`,
                      lineHeight: 1.2
                    }}
                  >
                    {abbreviation}
                  </div>
                </div>
              </div>
            </header>

            {/* Pestañas de Navegación */}
            <nav className="flex justify-around bg-[#455a64]">
              {tabs.map((tab) => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`py-3 px-4 text-sm font-bold uppercase tracking-wider transition-colors duration-200 w-full ${activeTab === tab ? 'text-white border-b-4 border-[#00bfa5]' : 'text-gray-400'}`}
                >
                  {tab}
                </button>
              ))}
            </nav>

            {/* Contenido Principal */}
            <main className="flex-grow bg-[#f5f5f5] text-gray-800 p-4 overflow-y-auto">
              {activeTab === 'ASPECTO' && (
                <div>
                  <div className="bg-white rounded-xl shadow p-3 mb-4">
                    <label htmlFor="abbreviation" className="text-xs font-bold text-gray-500 uppercase px-1">Abreviatura</label>
                    <input
                      id="abbreviation"
                      type="text"
                      value={abbreviation}
                      onChange={(e) => setAbbreviation(e.target.value)}
                      className="w-full mt-1 bg-gray-100 p-3 rounded-lg border border-gray-300 focus:border-teal-400 focus:ring-0 text-base"
                      maxLength="5"
                    />
                  </div>

                  <ColorPicker label="COLOR DE FONDO" colors={bgColors} selectedColor={bgColor} onColorSelect={setBgColor} />
                  <ColorPicker label="COLOR DE TEXTO" colors={textColors} selectedColor={textColor} onColorSelect={setTextColor} />
                  
                  <div className="bg-white rounded-xl shadow p-4">
                    <h3 className="text-xs font-bold text-gray-500 uppercase px-1 mb-3">TAMAÑO DEL TEXTO</h3>
                    <div className="flex items-center space-x-4 px-2">
                      <span className="text-lg font-bold w-8 text-center">{textSize}</span>
                      <input
                        type="range"
                        min="8"
                        max="24"
                        value={textSize}
                        onChange={(e) => setTextSize(parseInt(e.target.value))}
                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-teal-500"
                      />
                    </div>
                  </div>
                </div>
              )}
              {activeTab === 'HORARIOS' && (
                <div>
                  <div className="bg-white rounded-xl shadow p-3 mb-4">
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="text-xs font-bold text-gray-500 uppercase px-1">Horarios</h3>
                      <button
                        onClick={handleAddTimeSlot}
                        className="px-4 py-2 bg-green-500 text-white rounded-lg text-xs font-semibold hover:bg-green-600 transition-colors"
                      >
                        + Añadir
                      </button>
                    </div>
                    <div className="space-y-2">
                      {timeSlots.map((slot, index) => (
                        <TimeSlot
                          key={index}
                          slot={slot}
                          index={index}
                          onUpdate={handleUpdateTimeSlot}
                          onDelete={handleDeleteTimeSlot}
                        />
                      ))}
                    </div>
                  </div>
                </div>
              )}
              {activeTab === 'ACCIONES' && (
                  <div className="text-center text-gray-500 py-10">
                      <p>Contenido para '{activeTab}' no implementado.</p>
                  </div>
              )}
            </main>

            {/* Footer con acciones */}
            <footer className="bg-[#455a64] p-3 border-t-2 border-[#546e7a]">
              <div className="flex items-center justify-between">
                <button onClick={handleDelete} className="bg-red-600 hover:bg-red-700 transition-colors p-3.5 rounded-full shadow-lg">
                  <TrashIcon />
                </button>
                <div className="flex items-center space-x-3">
                  <button onClick={handleCancel} className="bg-[#617d8a] hover:bg-[#78909c] transition-colors text-white font-bold py-3 px-6 rounded-full text-sm uppercase shadow-md">CANCELAR</button>
                  <button onClick={handleSave} className="bg-[#617d8a] hover:bg-[#78909c] transition-colors text-white font-bold py-3 px-8 rounded-full text-sm uppercase shadow-md">GUARDAR</button>
                </div>
              </div>
            </footer>
          </div>
        );
      }
      
      // Montar la aplicación en el DOM
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
</body>
</html>